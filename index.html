<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>UNDRA ENGINE v1.1</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
    }
    h1,h2,h3 {
      color:#f5e6b3;
    }
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }
    .steps-nav {
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .steps-nav button {
      flex:1;
      padding:8px;
      background:#222;
      color:#eee;
      border:1px solid #555;
      cursor:pointer;
    }
    .steps-nav button.active {
      background:#444;
      border-color:#d4af37;
      color:#fff;
    }
    .step {
      display:none;
      border:1px solid #333;
      padding:12px;
      border-radius:4px;
      background:#181818;
      margin-bottom:16px;
    }
    .step.active { display:block; }
    .flex { display:flex; gap:16px; }
    .column { flex:1; min-width:0; }
    .attr-row, .skill-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .val-box {
      min-width:32px;
      text-align:center;
      padding:2px 4px;
      border:1px solid #555;
      border-radius:3px;
      background:#222;
      color:#f5e6b3;
    }
    .btn, .btn-upgrade {
      padding:4px 8px;
      background:#333;
      border:1px solid #777;
      color:#eee;
      cursor:pointer;
      border-radius:3px;
      font-size:12px;
    }
    .btn.primary {
      background:#d4af37;
      color:#111;
      border-color:#f5e6b3;
    }
    .portrait-box, .final-portrait-box {
      width:180px;
      height:220px;
      border:1px solid #555;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
    }
    .portrait-box img,
    .final-portrait-box img {
      max-width:100%;
      max-height:100%;
    }
    canvas {
      background:#000;
      border:1px solid #555;
    }
    textarea {
      width:100%;
      min-height:100px;
      background:#111;
      color:#eee;
      border:1px solid #555;
      border-radius:3px;
      padding:4px;
      font-size:12px;
    }
    input, select {
      background:#111;
      color:#eee;
      border:1px solid #555;
      border-radius:3px;
      padding:3px;
      font-size:12px;
    }
    .small-label {
      font-size:11px;
      color:#aaa;
    }
    .dice-box {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .dice-btn {
      padding:6px 8px;
      font-size:13px;
      background:#222;
      color:#f5e6b3;
      border:1px solid #d4af37;
      border-radius:4px;
      cursor:pointer;
    }
    #last-roll {
      font-size:12px;
      margin-bottom:8px;
    }
    .history-box,
    .timeline-box,
    .skills-list,
    #combat-log,
    #travel-log,
    #quest-log,
    #merchant-log,
    #rest-log,
    #status-log,
    #money-history {
      max-height:220px;
      overflow-y:auto;
      border:1px solid #333;
      padding:6px;
      background:#101010;
      font-size:12px;
    }
    .history-entry, .timeline-entry { margin-bottom:3px; }
    .inv-grid { display:grid; gap:4px; }
    .inv-slot {
      display:flex;
      align-items:center;
      gap:4px;
      border:1px solid #333;
      padding:2px 4px;
    }
    .inv-icon { width:20px; text-align:center; }
    .tag {
      display:inline-block;
      padding:2px 6px;
      margin:2px;
      border-radius:3px;
      border:1px solid #555;
      font-size:11px;
      cursor:pointer;
    }
    .tag.selected {
      background:#d4af37;
      color:#111;
      border-color:#f5e6b3;
    }
    .top-bar {
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
      font-size:12px;
    }
    .hidden { display:none !important; }
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:1000;
    }
    .modal {
      background:#181818;
      border:1px solid #555;
      padding:16px;
      border-radius:4px;
      max-width:380px;
      width:90%;
      color:#eee;
      font-size:13px;
    }
    .row { margin-bottom:6px; }
    .currency-display, .sp-display {
      margin-bottom:4px;
      font-size:13px;
    }
    #combat-ui.hidden { display:none; }
    .status-icon {
      width:20px;
      height:20px;
      border-radius:50%;
      border:1px solid #555;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      margin-right:4px;
      cursor:pointer;
    }
    .ability-row {
      border-bottom:1px solid #333;
      padding:4px 0;
      font-size:12px;
    }
    .ability-name.learned { color:#d4af37; }
    .merchant-slot {
      display:flex;
      align-items:center;
      gap:4px;
      border:1px solid #333;
      padding:2px 4px;
      margin-bottom:2px;
    }
    #rest-dropdown { position:relative; }
    #rest-dropdown-menu {
      position:absolute;
      top:100%;
      left:0;
      background:#222;
      border:1px solid #555;
      padding:4px;
      z-index:500;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>UNDRA ENGINE v1.1</h1>
  <div class="top-bar">
    <div>Version: <span id="version-tag">1.1</span></div>
    <div>Aktueller Tag: <span id="day-display">1</span></div>
  </div>

  <div class="steps-nav">
    <button id="nav-step-1" class="active" onclick="toStep(1)">STEP 1 – Ursprung</button>
    <button id="nav-step-2" onclick="toStep(2)">STEP 2 – Entscheidungen</button>
    <button id="nav-step-3" onclick="toStep(3)">STEP 3 – Aventur</button>
  </div>

  <!-- STEP 1 -->
  <div id="step-1" class="step active">
    <div class="flex">
      <div class="column">
        <h2>Portrait & Basisdaten</h2>
        <div class="portrait-box">
          <img id="preview" alt="Portrait">
        </div>
        <div class="row">
          <input type="file" id="portrait-input" accept="image/*">
        </div>
        <div class="row">
          <label class="small-label">Name:</label>
          <input type="text" id="char-name" placeholder="Name">
        </div>
        <div class="row">
          <label class="small-label">Rasse:</label>
          <select id="race-select"></select>
        </div>
        <div class="row">
          <label class="small-label">Profession:</label>
          <select id="profession-select"></select>
        </div>
        <div class="row">
          <button class="btn" onclick="openSpecialModal()">Spezialfähigkeit</button>
        </div>
      </div>

      <div class="column">
        <h2>Attribute</h2>
        <div id="attr-grid"></div>
        <div class="row">
          <button class="btn" onclick="randomizeAttributes()">Attribute würfeln</button>
        </div>
        <h3>Attribut-Radar</h3>
        <canvas id="attrRadar" width="260" height="260"></canvas>
      </div>

      <div class="column">
        <h2>Chronik – Ursprung</h2>
        <textarea id="origin-text" placeholder="Beschreibe Ursprung, Kindheit, Herkunft..."></textarea>
        <div class="row">
          <button class="btn primary" onclick="toStep(2)">Weiter zu STEP 2</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div id="step-2" class="step">
    <div class="flex">
      <div class="column">
        <h2>Vorteile</h2>
        <div id="vorteile-list"></div>
      </div>
      <div class="column">
        <h2>Nachteile</h2>
        <div id="nachteile-list"></div>
      </div>
      <div class="column">
        <h2>Chronik – Entscheidungen</h2>
        <textarea id="chronik-text" placeholder="Entscheidungen, Wendepunkte, Verluste, Schwüre..."></textarea>
        <div class="row small-label" id="vn-status"></div>
        <div class="row">
          <button class="btn" onclick="toStep(1)">Zurück zu STEP 1</button>
          <button class="btn primary" id="finish-step-2-btn" disabled onclick="toStep(3)">Erstellung abschließen</button>
        </div>
        <h3>Entscheidungs-Radar</h3>
        <canvas id="chronikRadar" width="260" height="260"></canvas>
      </div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div id="step-3" class="step">
    <div class="flex">
      <div class="column">
        <h2>Finalportrait & Vitalwerte</h2>
        <div class="final-portrait-box">
          <img id="final-portrait" alt="Finalportrait">
        </div>
        <div class="row">
          LE: <span id="calc-le-val">0</span> |
          EN: <span id="calc-en-val">0</span> |
          RS: <span id="calc-rs-val">0</span> |
          GG: <span id="calc-gg-val">0</span> |
          TC: <span id="calc-tc-val">0</span>
        </div>
        <h3>Final-Radar</h3>
        <canvas id="finalRadar" width="260" height="260"></canvas>
        <div class="row">
          <span class="small-label">Leben: <span id="life-current"></span>/<span id="life-max"></span></span><br>
          <span class="small-label">Ausdauer: <span id="stamina-current"></span>/<span id="stamina-max"></span></span>
        </div>
        <div class="row small-label">
          Rüstungspuffer: <span id="armor-buffer">0</span>
          <button class="btn" onclick="upgradeArmorBuffer()">Puffer steigern</button>
        </div>
        <div class="row small-label">
          Trefferzone: <span id="zone-info-name"></span> – <span id="zone-info-state"></span>
        </div>
      </div>

      <div class="column">
        <h2>Aktive Attribute & Würfel</h2>
        <div class="row small-label">Tagespunkte: <span id="daily-points-display">0</span></div>
        <div id="active-attr-grid"></div>
        <h3>Würfel</h3>
        <div id="dice-box" class="dice-box"></div>
        <div id="last-roll">Noch kein Wurf</div>
        <div class="row">
          <button class="btn" onclick="playerAttack()">Angriff</button>
          <button class="btn" onclick="playerDefend()">Verteidigung</button>
          <button class="btn" onclick="playerDodge()">Ausweichen</button>
        </div>
        <div class="row">
          <button class="btn" onclick="openProbePopup()">Probe</button>
          <button class="btn" onclick="openEnemyLevelMenu()">Gegner erzeugen</button>
        </div>
        <div class="row small-label">
          <div id="combat-ui" class="hidden">
            Gegner: <span id="enemy-name">—</span> |
            LP: <span id="enemy-life">-</span>
          </div>
        </div>
        <h3>Kampf-Log</h3>
        <div id="combat-log"></div>
      </div>

      <div class="column">
        <h2>Inventar & Tag</h2>
        <div class="currency-display">
          Währung: <span id="currency-display">0 G 0 S 0 K</span>
        </div>
        <div class="sp-display">
          SP: <span id="sp-display">0</span>
        </div>
        <h3>Inventar</h3>
        <div class="inv-grid">
          <div>
            <strong>Klein</strong>
            <div id="inv-small"></div>
          </div>
          <div>
            <strong>Mittel</strong>
            <div id="inv-medium"></div>
          </div>
          <div>
            <strong>Groß</strong>
            <div id="inv-large"></div>
          </div>
        </div>
        <h3>Ausrüstung</h3>
        <div class="row small-label">
          Waffe: <span id="equip-weapon">—</span>
          <button class="btn" onclick="unequipItem('weapon')">Ablegen</button>
        </div>
        <div class="row small-label">
          Rüstung: <span id="equip-armor">—</span>
          <button class="btn" onclick="unequipItem('armor')">Ablegen</button>
        </div>
        <div class="row">
          <button class="btn" onclick="openSellPopup('small',0)">Verkauf / Test</button>
        </div>
        <div class="row">
          <button class="btn primary" onclick="endDay()">Tag beenden</button>
        </div>
        <h3>Timeline (Tage)</h3>
        <div id="timeline-box" class="timeline-box"></div>
      </div>
    </div>

    <div class="flex" style="margin-top:16px;">
      <div class="column">
        <h2>Historie</h2>
        <div id="history-box" class="history-box"></div>
      </div>
      <div class="column">
        <h2>Skills & Fähigkeiten</h2>
        <h4>Kompetenz-Fähigkeiten</h4>
        <div class="skills-list" id="skills-list"></div>
        <h4>Modul-8-Kampf-Fähigkeiten</h4>
        <div id="ability-list" class="skills-list"></div>
        <h4>Seite-3-Fähigkeiten (Modul 16)</h4>
        <div class="skills-list">
          <div><strong>Basis</strong></div>
          <div id="abilities-basic"></div>
          <div><strong>Rasse</strong></div>
          <div id="abilities-race"></div>
          <div><strong>Profession</strong></div>
          <div id="abilities-profession"></div>
          <div class="small-label">Verfügbare SP: <span id="abilities-sp-available">0</span></div>
          <div id="ability-log"></div>
        </div>
      </div>
      <div class="column">
        <h2>Reise / Quests / Status / Ruhe</h2>
        <h4>Reise</h4>
        <button class="btn" onclick="openTravelMenu()">Reise starten</button>
        <div id="travel-log"></div>
        <h4>Quests</h4>
        <button class="btn" onclick="openQuestCompletePopup()">Quest abschließen (Code)</button>
        <button class="btn" onclick="openQuestRewardPopup()">Quest-Belohnung einlösen</button>
        <div id="quest-log"></div>
        <h4>Status-Effekte</h4>
        <div id="status-effects"></div>
        <div id="status-log"></div>
        <h4>Rast</h4>
        <div id="rest-dropdown">
          <button class="btn" onclick="openRestDropdown()">Rasten</button>
          <div id="rest-dropdown-menu" class="hidden">
            <button class="btn" onclick="restShort()">Kurze Rast</button>
            <button class="btn" onclick="restCamp()">Lager errichten</button>
            <button class="btn" onclick="openOvernightOptions()">Übernachtung</button>
          </div>
        </div>
        <div id="rest-log"></div>
        <h4>Buffs</h4>
        <div id="buff-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- SPEZIALFÄHIGKEIT -->
<div id="special-modal" class="modal-backdrop">
  <div class="modal">
    <h3>Spezialfähigkeit</h3>
    <div id="special-content"></div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeSpecialModal()">Schließen</button>
    </div>
  </div>
</div>

<!-- DANKES-MODAL / TAG BEENDEN -->
<div id="thanks-modal" class="modal-backdrop">
  <div class="modal">
    <h3>Tag beendet</h3>
    <div id="thanks-text"></div>
    <div class="row" style="text-align:right;">
      <button class="btn primary" onclick="closeThanks()">Weiter</button>
    </div>
  </div>
</div>

<!-- REPARATUR POPUP (Rüstungspuffer/Zone) -->
<div id="popup-armor-repair" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Rüstungsreparatur</h3>
    <div id="popup-armor-text"></div>
    <div class="row">
      <button id="btn-repair-gold" class="btn">Mit Gold reparieren</button>
      <button id="btn-repair-sp" class="btn">Mit SP reparieren</button>
    </div>
    <div class="row" style="text-align:right;">
      <button id="btn-repair-cancel" class="btn">Abbrechen</button>
    </div>
  </div>
</div>

<!-- INVENTAR-VERKAUF POPUP -->
<div id="sell-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Item-Aktion</h3>
    <div class="row">
      <button class="btn" onclick="openSellValuePopup()">Verkaufen</button>
      <button class="btn" onclick="discardItem()">Wegwerfen</button>
    </div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeSellPopup()">Schließen</button>
    </div>
  </div>
</div>

<div id="sell-value-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Verkaufspreis</h3>
    <div class="row small-label">Gold:</div>
    <input type="number" id="sell-gold" value="0" min="0">
    <div class="row small-label">Silber:</div>
    <input type="number" id="sell-silver" value="0" min="0">
    <div class="row small-label">Kupfer:</div>
    <input type="number" id="sell-copper" value="0" min="0">
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeSellValuePopup()">Abbrechen</button>
      <button class="btn primary" onclick="confirmSell()">Verkaufen</button>
    </div>
  </div>
</div>

<!-- PROBEN-POPUP -->
<div id="probe-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Probe</h3>
    <div class="row small-label">
      Ergebnis:
    </div>
    <div id="probe-result"></div>
    <div class="row">
      <button class="btn" onclick="performAttributeProbe('IN')">IN-Probe</button>
      <button class="btn" onclick="performAttributeProbe('GE')">GE-Probe</button>
      <button class="btn" onclick="performCombinedProbe('KK','GE')">KK+GE</button>
    </div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeProbePopup()">Schließen</button>
    </div>
  </div>
</div>

<!-- GELD-HISTORIE -->
<div id="money-history" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Geld-Historie</h3>
    <div id="money-history-list"></div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeMoneyHistory()">Schließen</button>
    </div>
  </div>
</div>

<!-- GEGNER-LEVEL AUSWAHL -->
<div id="enemy-level-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Gegner-Level wählen</h3>
    <div class="row">
      <button class="btn" onclick="chooseEnemyLevel(1)">1</button>
      <button class="btn" onclick="chooseEnemyLevel(3)">3</button>
      <button class="btn" onclick="chooseEnemyLevel(5)">5</button>
    </div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeEnemyLevelMenu()">Abbrechen</button>
    </div>
  </div>
</div>

<!-- GEGNER-TYP AUSWAHL -->
<div id="enemy-type-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Gegner-Typ wählen</h3>
    <div class="row">
      <button class="btn" onclick="chooseEnemyType('humanoid')">Humanoid</button>
      <button class="btn" onclick="chooseEnemyType('beast')">Tier</button>
      <button class="btn" onclick="chooseEnemyType('undead')">Untot</button>
      <button class="btn" onclick="chooseEnemyType('demon')">Dämon</button>
    </div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeEnemyTypeMenu()">Abbrechen</button>
    </div>
  </div>
</div>

<!-- REISE-POPUPS -->
<div id="travel-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Reiseziel wählen</h3>
    <div id="travel-zone-list"></div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeTravelMenu()">Schließen</button>
    </div>
  </div>
</div>

<div id="travel-confirm-popup" class="modal-backdrop hidden" data-zone-id="">
  <div class="modal">
    <h3>Reise bestätigen</h3>
    <div class="row">
      Ziel: <span id="travel-confirm-name"></span>
    </div>
    <div class="row small-label">
      Dauer: <span id="travel-confirm-time"></span> | Gefahr: <span id="travel-confirm-danger"></span>
    </div>
    <div class="row" id="travel-confirm-desc"></div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeZoneConfirm()">Abbrechen</button>
      <button class="btn primary" onclick="confirmTravel()">Reisen</button>
    </div>
  </div>
</div>

<div id="zone-probe-popup" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Zonenprobe</h3>
    <div id="zone-probe-desc"></div>
    <div class="row small-label">
      Attribut: <span id="zone-probe-attr"></span> – Schwierigkeit: <span id="zone-probe-diff"></span>
    </div>
    <div class="row">
      <button class="btn" onclick="performZoneEventProbe()">Probe ablegen</button>
    </div>
    <div class="row" style="text-align:right;">
      <button class="btn" onclick="closeZoneProbePopup()">Schließen</button>
    </div>
  </
