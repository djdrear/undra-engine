<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>UNDRA ENGINE v1.0</title>
    <!-- BLOCK 7: UI-Upgrade -->
  <style>
    ‚Ä¶<!-- BLOCK 7 START -->
<style>
body {
  background: #0f0f0f;
  color: #e0e0e0;
  font-family: 'Cinzel', serif;
  margin: 0;
  padding: 0;
}

h2, h3 {
  font-family: 'Cinzel', serif;
  color: #ffd700;
  margin-bottom: 6px;
}

.panel {
  padding: 20px;
  border: 1px solid #333;
  background: #1a1a1a;
  margin: 10px;
  border-radius: 6px;
}

.panel.hidden {
  display: none;
}

.section {
  margin-bottom: 20px;
}

label {
  display: block;
  margin-bottom: 6px;
  font-weight: bold;
  color: #ccc;
}

input[type="text"],
input[type="number"],
select,
textarea {
  width: 100%;
  padding: 6px;
  margin-top: 2px;
  background: #222;
  color: #fff;
  border: 1px solid #444;
  border-radius: 4px;
  font-family: 'Cinzel', serif;
}

textarea {
  height: 80px;
  resize: vertical;
}

button {
  background: #444;
  color: #fff;
  border: none;
  padding: 8px 12px;
  margin: 4px 2px;
  border-radius: 4px;
  cursor: pointer;
  font-family: 'Cinzel', serif;
  transition: background 0.2s ease;
}

button:hover {
  background: #666;
}

.btn-accent {
  background: #ffd700;
  color: #000;
}

.btn-accent:hover {
  background: #ffec80;
}

.attr-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
}

.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.multi-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 6px;
}

.list-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid #333;
}

.stat-bar {
  background: #333;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 4px;
}

.stat-bar-fill {
  background: #ffd700;
  height: 100%;
}

.stat-bar-label {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  margin-bottom: 2px;
}

.pill {
  background: #444;
  color: #fff;
  padding: 2px 6px;
  border-radius: 12px;
  font-size: 12px;
  margin-left: 6px;
}

.small {
  font-size: 12px;
  color: #aaa;
}

hr {
  border: none;
  border-top: 1px solid #333;
  margin: 12px 0;
}
</style>
<!-- BLOCK 7 END -->
</head>

<!-- BLOCK 1A START -->
<div id="page1" class="panel panel-left">
  <div class="section">
    <h3>URSPRUNG & BLUTLINIEN</h3>

    <label>Name des Helden
      <input type="text" id="char-name" placeholder="Name deines Helden">
    </label>

    <label>Titel / Beiname
      <input type="text" id="char-title" placeholder="z.‚ÄØB. Der Verlorene, Flammenkind">
    </label>

    <label>Portrait hochladen
      <input type="file" id="char-portrait" accept="image/*">
    </label>
    <div id="char-portrait-preview" class="small">Kein Portrait geladen.</div>

    <div class="two-col" style="margin-top:10px;">
      <div>
        <label>Rasse
          <select id="char-race">
            <option value="human">Mensch</option>
            <option value="dwarf">Zwerg</option>
            <option value="halfling">Halbling</option>
            <option value="dragonborn">Drachgeborene</option>
            <option value="lizardfolk">Echsenmenschen</option>
            <option value="serpentfolk">Schlangenmenschen</option>
            <option value="orc">Ork</option>
            <option value="goblin">Goblin</option>
            <option value="gnome">Gnom</option>
            <option value="tabaxi">Tabaxi</option>
            <option value="halfOrc">Halborken</option>
            <option value="elf">Elf</option>
            <option value="aetherborn">Aethergeborener</option>
          </select>
        </label>

        <label>Untergruppe
          <input type="text" id="char-subrace" placeholder="z.‚ÄØB. Bergzwerg, Blutlinie der Flamme">
        </label>

        <label>Profession
          <input type="text" id="char-profession" placeholder="z.‚ÄØB. Klingenpriester, Schattenl√§ufer">
        </label>

        <label>Spezial
          <input type="text" id="char-special" placeholder="z.‚ÄØB. Drachenmacht, Seelenband">
        </label>
      </div>

      <div>
        <label>Merkmale
          <input type="text" id="char-traits" placeholder="z.‚ÄØB. Nachtauge, Ritualkundig">
        </label>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>BASISATTRIBUTE</h3>
    <div class="small">Max. 20 pro Attribut ‚Äì Konto steuert die Gesamtpunkte.</div>

    <div class="attr-grid" style="margin-top:6px;">
      <label>Mut</label><input id="attr-courage" type="number" value="10" min="1" max="20">
      <label>Fingerfertigkeit</label><input id="attr-dexterity" type="number" value="10" min="1" max="20">
      <label>K√∂rperkraft</label><input id="attr-strength" type="number" value="10" min="1" max="20">
      <label>Konstitution</label><input id="attr-toughness" type="number" value="10" min="1" max="20">
      <label>Sozialstatus</label><input id="attr-status" type="number" value="10" min="1" max="20">
      <label>Intuition</label><input id="attr-intuition" type="number" value="10" min="1" max="20">
      <label>Verteidigung</label><input id="attr-defense" type="number" value="10" min="1" max="20">
      <label>Fernkampf</label><input id="attr-ranged" type="number" value="10" min="1" max="20">
      <label>Technik</label><input id="attr-tech" type="number" value="10" min="1" max="20">
      <label>Intelligenz</label><input id="attr-intellect" type="number" value="10" min="1" max="20">
      <label>Gewandtheit</label><input id="attr-agility" type="number" value="10" min="1" max="20">
      <label>K√∂rperbewusstsein</label><input id="attr-bodyAwareness" type="number" value="10" min="1" max="20">
      <label>Charisma</label><input id="attr-charisma" type="number" value="10" min="1" max="20">
      <label>Geistiger Zustand</label><input id="attr-mind" type="number" value="10" min="1" max="20">
      <label>Angriff</label><input id="attr-attack" type="number" value="10" min="1" max="20">
      <label>Abwehrschlag</label><input id="attr-counter" type="number" value="10" min="1" max="20">
      <label>Trefferchance</label><input id="attr-hit" type="number" value="10" min="1" max="20">
    </div>

    <hr>

    <div class="two-col">
      <div>
        <div class="small">Konto (Gesamt), Verbraucht, √úbrig</div>
        <div class="small">Konto: <span id="points-total">0</span></div>
        <div class="small">Verbraucht: <span id="points-spent">0</span></div>
        <div class="small">√úbrig: <span id="points-left">0</span></div>
      </div>
      <div style="text-align:right;">
        <button onclick="rollAttributePoints()">PUNKTE AUSW√úRFELN</button>
        <button onclick="resetAttributes()">RESET</button>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Hintergrund</h3>
    <div class="small">Kurze Beschreibung deiner Herkunft, Blutlinie oder Besonderheit.</div>
    <textarea id="char-backstory" placeholder="Herkunft, Bruchpunkte, Gel√ºbde‚Ä¶"></textarea>

    <div style="margin-top:6px;text-align:right;">
      <button class="btn-accent" onclick="goToPage2()">Weiter zu Merkmalen</button>
    </div>
  </div>
</div>
<!-- BLOCK 1A END -->
<!-- BLOCK 1B START -->
<div id="page2" class="panel panel-right hidden">

  <!-- ERSCHEINUNG & IDENTIT√ÑT -->
  <div class="section">
    <h3>MERKMALE & IDENTIT√ÑT</h3>

    <div class="two-col">
      <div>
        <label>Alter
          <input type="number" id="char-age" value="25" min="1" max="200">
        </label>

        <label>Gr√∂√üe (cm)
          <input type="number" id="char-height" value="175" min="50" max="300">
        </label>

        <label>Gewicht (kg)
          <input type="number" id="char-weight" value="75" min="20" max="500">
        </label>

        <label>Aussehen
          <input type="text" id="char-appearance" placeholder="z.‚ÄØB. Narben, Haltung, Gesichtsz√ºge">
        </label>

        <label>Haare
          <input type="text" id="char-hair" placeholder="z.‚ÄØB. Schwarz, lang, geflochten">
        </label>

        <label>Haut / Fell
          <input type="text" id="char-skin" placeholder="z.‚ÄØB. Blass, bronzen, schuppig">
        </label>

        <label>Augen
          <input type="text" id="char-eyes" placeholder="z.‚ÄØB. Gr√ºn, bernstein, leuchtend">
        </label>

        <label>Hand
          <select id="char-hand">
            <option value="rechts">Rechts</option>
            <option value="links">Links</option>
            <option value="beidh√§ndig">Beidh√§ndig</option>
          </select>
        </label>
      </div>

      <div>
        <label>Stimme
          <input type="text" id="char-voice" placeholder="z.‚ÄØB. rau, melodisch, tief">
        </label>

        <label>Besonderheit
          <input type="text" id="char-specialFeature" placeholder="z.‚ÄØB. T√§towierung, Brandmal, Aura">
        </label>

        <label>Kleidung
          <input type="text" id="char-clothes" placeholder="z.‚ÄØB. Reisekleidung, Roben, R√ºstung">
        </label>

        <label>Akzent
          <input type="text" id="char-accent" placeholder="z.‚ÄØB. Nordisch, s√ºdlich, fremdl√§ndisch">
        </label>
      </div>
    </div>
  </div>

  <!-- VORTEILE & NACHTEILE -->
  <div class="section two-col">
    <div>
      <h3>Vorteile (+1 SP)</h3>
      <div class="multi-list" id="advantages-list">
        <!-- Wird per JS gef√ºllt -->
      </div>
    </div>

    <div>
      <h3>Nachteile (+1 SP)</h3>
      <div class="multi-list" id="disadvantages-list">
        <!-- Wird per JS gef√ºllt -->
      </div>
    </div>
  </div>

  <!-- REGELHINWEIS -->
  <div class="section">
    <div class="small">
      <strong>Bedingung:</strong> Mindestens 2 Vorteile.  
      Nachteile m√ºssen immer die Anzahl der Vorteile um <strong>+1</strong> √ºbersteigen.
    </div>
    <div id="trait-warning" class="small" style="color:#ff6b6b;margin-top:6px;"></div>
  </div>

  <!-- HELDEN-CHRONIK -->
  <div class="section">
    <h3>HELDEN-CHRONIK</h3>
    <div id="hero-chronicle">
      <!-- Wird dynamisch gef√ºllt -->
    </div>
  </div>

  <!-- BUTTON ZU SEITE 3 -->
  <div class="section" style="text-align:right;">
    <button class="btn-accent" onclick="goToPage3()">Weiter zu Seite 3 (Engine)</button>
  </div>

</div>
<!-- BLOCK 1B END -->
<!-- BLOCK 1C START -->
<script>
/* ============================================================
   NAVIGATION
   ============================================================ */
function showPage(n) {
  document.getElementById("page1").classList.add("hidden");
  document.getElementById("page2").classList.add("hidden");
  document.getElementById("page3").classList.add("hidden");
  document.getElementById("page" + n).classList.remove("hidden");
}

function goToPage2() {
  updatePointSummary();
  renderAdvantageLists();
  updateTraitWarning();
  renderChronicle();
  showPage(2);
}

function goToPage3() {
  if (!validateTraits()) return;
  collectFinalCharacterData();
  showPage(3);
}

/* ============================================================
   ATTRIBUTE ‚Äì Punktesystem
   ============================================================ */
function getAllAttributeIds() {
  return [
    "courage","dexterity","strength","toughness","status","intuition",
    "defense","ranged","tech","intellect","agility","bodyAwareness",
    "charisma","mind","attack","counter","hit"
  ];
}

function readAttributesFromInputs() {
  const ids = getAllAttributeIds();
  const result = {};
  ids.forEach(id => {
    const el = document.getElementById("attr-" + id);
    result[id] = el ? parseInt(el.value) || 0 : 0;
  });
  return result;
}

function updatePointSummary() {
  const attrs = readAttributesFromInputs();
  const base = 10;
  let spent = 0;

  Object.values(attrs).forEach(v => spent += (v - base));

  const total = 50;
  const left = total - spent;

  document.getElementById("points-total").textContent = total;
  document.getElementById("points-spent").textContent = spent;
  document.getElementById("points-left").textContent = left;
}

function rollAttributePoints() {
  const ids = getAllAttributeIds();
  ids.forEach(id => {
    const el = document.getElementById("attr-" + id);
    if (!el) return;
    el.value = 8 + Math.floor(Math.random() * 6); // 8‚Äì13
  });
  updatePointSummary();
}

function resetAttributes() {
  const ids = getAllAttributeIds();
  ids.forEach(id => {
    const el = document.getElementById("attr-" + id);
    if (!el) return;
    el.value = 10;
  });
  updatePointSummary();
}

/* ============================================================
   VORTEILE & NACHTEILE ‚Äì Listen
   ============================================================ */
const ADVANTAGES = [
  "Wachsam","Wetterfest","Tierfreund","Gutes Geh√∂r","Sprachtalent",
  "Richtungssinn","Reiche Eltern","Schlangenmensch","Hitzeresistenz",
  "Scharfer Blick","Schnelle Reflexe","Z√§her K√∂rper","Magisches Talent",
  "Gute Intuition","Kampfgeist","Gute Kondition","Guter Ruf","Flink",
  "Starker Wille","Gute Menschenkenntnis","Gute Balance","Guter Geruchssinn",
  "Schnelles Lernen","Gute Konzentration","Hohe Belastbarkeit",
  "Gute Orientierung","Gute Reaktion","Gute Wahrnehmung","Gute Stimme",
  "Gute Ausstrahlung","Gute Geschicklichkeit","Gute Technik","Gute Planung",
  "Gute Taktik","Gute Analyse","Gute Kreativit√§t","Gute Anpassung",
  "Gute Selbstbeherrschung","Gute Disziplin","Gute Ausdauer",
  "Gute Beweglichkeit","Gute Stabilit√§t","Gute Pr√§zision","Gute Kontrolle",
  "Gute Verteidigung","Gute Angriffskraft","Gute Trefferchance",
  "Gute Resistenz","Gute Robustheit"
];

const DISADVANTAGES = [
  "Farbenblind","Tiefschl√§fer","Platzangst","Aberglaube","Wasserscheu",
  "H√∂henangst","Goldgier","Prinzipientreue","Tollpatsch","Schwache Kondition",
  "Schwache Reflexe","Schwache Wahrnehmung","Schwache Stimme","Schwache Technik",
  "Schwache Planung","Schwache Taktik","Schwache Analyse","Schwache Kreativit√§t",
  "Schwache Anpassung","Schwache Selbstbeherrschung","Schwache Disziplin",
  "Schwache Ausdauer","Schwache Beweglichkeit","Schwache Stabilit√§t",
  "Schwache Pr√§zision","Schwache Kontrolle","Schwache Verteidigung",
  "Schwache Angriffskraft","Schwache Trefferchance","Schwache Resistenz",
  "Schwache Robustheit","Schwache Intuition","Schwache Konzentration",
  "Schwache Orientierung","Schwache Reaktion","Schwache Menschenkenntnis",
  "Schwache Balance","Schwacher Geruchssinn","Schwaches Lernen",
  "Schwache Belastbarkeit","Schwache Ausstrahlung","Schwache Geschicklichkeit",
  "Schwache Technikkenntnis","Schwache Planung","Schwache Analyse",
  "Schwache Kreativit√§t","Schwache Anpassung","Schwache Disziplin"
];

function renderAdvantageLists() {
  const advBox = document.getElementById("advantages-list");
  const disBox = document.getElementById("disadvantages-list");

  advBox.innerHTML = "";
  disBox.innerHTML = "";

  ADVANTAGES.forEach((name, i) => {
    advBox.innerHTML += `<label><input type="checkbox" class="adv" value="${name}"> ${name}</label>`;
  });

  DISADVANTAGES.forEach((name, i) => {
    disBox.innerHTML += `<label><input type="checkbox" class="dis" value="${name}"> ${name}</label>`;
  });

  advBox.addEventListener("change", updateTraitWarning);
  disBox.addEventListener("change", updateTraitWarning);
}

/* ============================================================
   REGELPR√úFUNG
   ============================================================ */
function validateTraits() {
  const adv = [...document.querySelectorAll(".adv:checked")].length;
  const dis = [...document.querySelectorAll(".dis:checked")].length;

  if (adv < 2) {
    document.getElementById("trait-warning").textContent =
      "Du brauchst mindestens 2 Vorteile.";
    return false;
  }

  if (dis !== adv + 1) {
    document.getElementById("trait-warning").textContent =
      `Du hast ${adv} Vorteile ‚Äì du brauchst ${adv + 1} Nachteile.`;
    return false;
  }

  document.getElementById("trait-warning").textContent = "";
  return true;
}

function updateTraitWarning() {
  validateTraits();
  renderChronicle();
}

/* ============================================================
   HELDEN-CHRONIK
   ============================================================ */
function renderChronicle() {
  const name = document.getElementById("char-name").value || "Namenloser";
  const age = document.getElementById("char-age").value;
  const height = document.getElementById("char-height").value;
  const weight = document.getElementById("char-weight").value;
  const hand = document.getElementById("char-hand").value;

  const hair = document.getElementById("char-hair").value || "-";
  const eyes = document.getElementById("char-eyes").value || "-";
  const skin = document.getElementById("char-skin").value || "-";

  const race = document.getElementById("char-race").value || "-";
  const profession = document.getElementById("char-profession").value || "-";

  const attrs = readAttributesFromInputs();

  const chronicle = `
    <strong>Name:</strong> ${name}<br><br>

    <strong>HERKUNFT</strong><br>
    Rasse: ${race}<br>
    Beruf: ${profession}<br>
    Alter: ${age}<br>
    Gr√∂√üe: ${height} cm<br>
    Gewicht: ${weight} kg<br>
    Hand: ${hand}<br><br>

    <strong>ERSCHEINUNG</strong><br>
    Augen: ${eyes}<br>
    Haare: ${hair}<br>
    Haut: ${skin}<br><br>

    <strong>BASISATTRIBUTE</strong><br>
    MU: ${attrs.courage} | IN: ${attrs.intuition} | FF: ${attrs.dexterity} | GE: ${attrs.agility}<br>
    KK: ${attrs.strength} | KB: ${attrs.bodyAwareness} | KO: ${attrs.toughness}<br>
    CH: ${attrs.charisma} | SS: ${attrs.status} | GZ: ${attrs.mind}<br>
    IT: ${attrs.intellect} | AN: ${attrs.attack} | VE: ${attrs.defense}<br>
    AS: ${attrs.counter} | FK: ${attrs.ranged} | TC: ${attrs.hit} | TE: ${attrs.tech}<br><br>

    <strong>MERKMALE</strong><br>
    Vorteile: ${[...document.querySelectorAll(".adv:checked")].map(e => e.value).join(", ") || "-"}<br>
    Nachteile: ${[...document.querySelectorAll(".dis:checked")].map(e => e.value).join(", ") || "-"}
  `;

  document.getElementById("hero-chronicle").innerHTML = chronicle;
}

/* ============================================================
   PORTRAIT-VORSCHAU
   ============================================================ */
document.addEventListener("change", function(e) {
  if (e.target && e.target.id === "char-portrait") {
    const box = document.getElementById("char-portrait-preview");
    const file = e.target.files[0];
    if (!file) {
      box.textContent = "Kein Portrait geladen.";
      return;
    }
    box.textContent = "Datei gew√§hlt: " + file.name;
  }
});

/* ============================================================
   √úBERGABE AN DIE ENGINE (SEITE 3)
   ============================================================ */
function collectFinalCharacterData() {
  const attrs = readAttributesFromInputs();

  const adv = [...document.querySelectorAll(".adv:checked")].map(e => e.value);
  const dis = [...document.querySelectorAll(".dis:checked")].map(e => e.value);

  const portraitInput = document.getElementById("char-portrait");
  const portraitName = portraitInput.files[0] ? portraitInput.files[0].name : null;

  window.UNDRA_CHARACTER = {
    name: document.getElementById("char-name").value,
    title: document.getElementById("char-title").value,
    race: document.getElementById("char-race").value,
    subrace: document.getElementById("char-subrace").value,
    profession: document.getElementById("char-profession").value,
    special: document.getElementById("char-special").value,
    traits: document.getElementById("char-traits").value,
    backstory: document.getElementById("char-backstory").value,
    attrs,
    advantages: adv,
    disadvantages: dis,
    appearance: {
      age: document.getElementById("char-age").value,
      height: document.getElementById("char-height").value,
      weight: document.getElementById("char-weight").value,
      hair: document.getElementById("char-hair").value,
      eyes: document.getElementById("char-eyes").value,
      skin: document.getElementById("char-skin").value,
      voice: document.getElementById("char-voice").value,
      clothes: document.getElementById("char-clothes").value,
      accent: document.getElementById("char-accent").value,
      specialFeature: document.getElementById("char-specialFeature").value,
      hand: document.getElementById("char-hand").value
    },
    portraitName
  };
}
</script>
<!-- BLOCK 1C END -->
<!-- BLOCK 2 START -->
<script>
/* ============================================================
   UNDRA ENGINE v1.0 ‚Äì CORE NAMESPACE
   ============================================================ */
window.UNDRA = {}; // global namespace

UNDRA.log = [];
function gameLog(msg) {
  UNDRA.log.push(msg);
  console.log("[UNDRA]", msg);

  const box = document.getElementById("game-log");
  if (box) {
    const div = document.createElement("div");
    div.textContent = msg;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
}

/* ============================================================
   UTILITIES
   ============================================================ */
function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}
function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj));
}
function rollD20() {
  return Math.floor(Math.random() * 20) + 1;
}
function rollDN(n = 6) {
  return Math.floor(Math.random() * n) + 1;
}
function rollDice(count, sides) {
  let total = 0;
  for (let i = 0; i < count; i++) total += rollDN(sides);
  return total;
}

/* ============================================================
   SKILL REGISTRY
   ============================================================ */
UNDRA.SkillRegistry = {
  athletics:  { id: "athletics",  name: "Athletik",    attribute: "strength",  description: "Klettern, Springen, Tragen, k√∂rperliche Leistung." },
  diplomacy:  { id: "diplomacy",  name: "Diplomatie",  attribute: "charisma",  description: "Verhandeln, √úberzeugen, Beruhigen." },
  intimidation:{ id:"intimidation",name:"Einsch√ºchtern",attribute:"presence", description:"Drohungen, Druck, Furcht erzeugen." },
  streetwise: { id: "streetwise", name: "Stra√üenkunde",attribute: "intellect", description: "L√ºgen, Betrug, Unterweltkontakte." },
  empathySkill:{id:"empathySkill",name:"Empathie",    attribute:"empathy",    description:"Gef√ºhle lesen, Mitgef√ºhl, Menschenkenntnis." },
  crafting:   { id:"crafting",    name:"Handwerk",    attribute:"intellect",  description:"Schmieden, reparieren, bauen." },
  alchemy:    { id:"alchemy",     name:"Alchemie",    attribute:"intellect",  description:"Tr√§nke, Gifte, Essenzen." },
  stealth:    { id:"stealth",     name:"Schleichen",  attribute:"agility",    description:"Lautlos bewegen, verbergen." },
  perception: { id:"perception",  name:"Wahrnehmung", attribute:"perception", description:"Sehen, h√∂ren, Details bemerken." }
};

/* ============================================================
   ITEM REGISTRY
   ============================================================ */
UNDRA.ItemRegistry = {
  sword: {
    id: "sword", name: "Schwert", type: "weapon",
    weight: 4, value: 30, rarity: "common", stackable: false,
    description: "Ein einfaches, aber zuverl√§ssiges Schwert.",
    damage: { min: 3, max: 8 }
  },
  dagger: {
    id: "dagger", name: "Dolch", type: "weapon",
    weight: 1, value: 10, rarity: "common", stackable: false,
    description: "Leichter Dolch, schnell gezogen.",
    damage: { min: 2, max: 5 }
  },
  leatherArmor: {
    id: "leatherArmor", name: "Lederharnisch", type: "armor",
    weight: 6, value: 25, rarity: "common", stackable: false,
    description: "Bietet leichten Schutz ohne gro√üe Einschr√§nkung.",
    armorValue: 1
  },
  chainArmor: {
    id: "chainArmor", name: "Kettenhemd", type: "armor",
    weight: 10, value: 60, rarity: "uncommon", stackable: false,
    description: "Solider Schutz gegen Hiebe.",
    armorValue: 2
  },
  healthPotion: {
    id: "healthPotion", name: "Heiltrank", type: "consumable",
    weight: 1, value: 15, rarity: "common", stackable: true,
    maxStack: 10, description: "Stellt eine moderate Menge Lebenspunkte wieder her."
  },
  ironOre: {
    id: "ironOre", name: "Eisenerz", type: "material",
    weight: 2, value: 5, rarity: "common", stackable: true,
    maxStack: 50, description: "Rohes Erz, Grundlage f√ºr Waffen und R√ºstungen."
  },
  herb: {
    id: "herb", name: "Kraut", type: "material",
    weight: 0.1, value: 2, rarity: "common", stackable: true,
    maxStack: 50, description: "Grundlage f√ºr einfache Tr√§nke."
  },
  water: {
    id: "water", name: "Flasche Wasser", type: "consumable",
    weight: 1, value: 1, rarity: "common", stackable: true,
    maxStack: 10, description: "L√∂scht Durst, Grundlage f√ºr Alchemie."
  },
  wood: {
    id: "wood", name: "Holz", type: "material",
    weight: 2, value: 3, rarity: "common", stackable: true,
    maxStack: 50, description: "Holz f√ºr Griffe, Sch√§fte, Strukturen."
  },
  rope: {
    id: "rope", name: "Seil", type: "tool",
    weight: 3, value: 3, rarity: "common", stackable: false,
    description: "N√ºtzlich zum Klettern, Sichern oder Fesseln."
  }
};

/* ============================================================
   RACE REGISTRY
   ============================================================ */
UNDRA.RaceRegistry = {
  human: {
    id: "human", name: "Mensch",
    modifiers: {}, traits: ["Anpassungsf√§hig","Vielseitig"], subraces: {}
  },
  elf: {
    id: "elf", name: "Elf",
    modifiers: { agility: 2, intellect: 1, perception: 2, strength: -1 },
    traits: ["Scharfsinnig","Langlebig"],
    subraces: {
      highElf: {
        id: "highElf", name: "Hochelf",
        modifiers: { intellect: 2, perception: 1 },
        traits: ["Arkaner Sinn"]
      },
      woodElf: {
        id: "woodElf", name: "Waldelf",
        modifiers: { agility: 1, perception: 1 },
        traits: ["Waldl√§ufer"]
      }
    }
  },
  dwarf: {
    id: "dwarf", name: "Zwerg",
    modifiers: { strength: 1, toughness: 2, agility: -1, willpower: 1 },
    traits: ["Z√§h","Handwerklich"],
    subraces: {
      mountain: {
        id: "mountain", name: "Bergzwerg",
        modifiers: { strength: 2, toughness: 1 },
        traits: ["Steinbau"]
      },
      hill: {
        id: "hill", name: "H√ºgelzwerg",
        modifiers: { toughness: 2 },
        traits: ["Widerstand"]
      }
    }
  },
  orc: {
    id: "orc", name: "Ork",
    modifiers: { strength: 2, toughness: 1, intellect: -1, charisma: -1, empathy: -1, presence: 1 },
    traits: ["Kraftvoll","Furchteinfl√∂√üend"],
    subraces: {}
  },
  halfling: {
    id: "halfling", name: "Halbling",
    modifiers: { agility: 2, perception: 1, charisma: 1, strength: -1 },
    traits: ["Gl√ºckspilz","Beh√§nde"],
    subraces: {}
  },
  aetherborn: {
    id: "aetherborn", name: "Aethergeborener",
    modifiers: { agility: 1, intellect: 2, perception: 1, willpower: 1 },
    traits: ["√Ñtherisch","Magisch begabt"],
    subraces: {
      voidTouched: {
        id: "voidTouched", name: "Leereber√ºhrt",
        modifiers: { willpower: 2 },
        traits: ["Leerenresonanz"]
      }
    }
  }
};

/* ============================================================
   STATUS EFFECTS
   ============================================================ */
UNDRA.StatusRegistry = {
  bleeding: {
    id: "bleeding", name: "Blutung", type: "debuff",
    durationType: "rounds",
    description: "Verliert jede Runde Lebenspunkte.",
    tick(target) { applyDamage(target, 2, "physisch", "Blutung"); }
  },
  poisoned: {
    id: "poisoned", name: "Vergiftet", type: "debuff",
    durationType: "rounds",
    description: "Schw√§cht den K√∂rper.",
    tick(target) { applyDamage(target, 1, "gift", "Vergiftung"); }
  },
  stunned: {
    id: "stunned", name: "Benommen", type: "debuff",
    durationType: "rounds",
    description: "Kann nicht handeln."
  },
  inspired: {
    id: "inspired", name: "Inspiriert", type: "buff",
    durationType: "rounds",
    description: "Erleichtert Proben."
  }
};

/* ============================================================
   PLAYER MODEL
   ============================================================ */
UNDRA.player = {
  name: "Unbenannter Held",
  title: "",
  race: "human",
  subrace: null,

  attributes: {
    strength: 10,
    toughness: 10,
    agility: 10,
    intellect: 10,
    perception: 10,
    willpower: 10,
    charisma: 10,
    empathy: 10,
    presence: 10
  },

  hp: { max: 50, current: 50 },
  gs: { max: 40, current: 40 },
  stamina: { base: 40, max: 40, current: 40 },
  fatigue: 0,

  skills: {
    athletics: { level: 1 },
    diplomacy: { level: 1 },
    intimidation: { level: 0 },
    streetwise: { level: 0 },
    empathySkill: { level: 1 },
    crafting: { level: 0 },
    alchemy: { level: 0 },
    stealth: { level: 0 },
    perception: { level: 1 }
  },

  equipment: {
    weapon: null,
    armor: null
  },

  inventory: [],
  money: { gold: 0, silver: 0, copper: 0 },

  statusEffects: [],
  reputation: { global: 0, factions: {} },

  position: { region: "forest", location: "forestEdge" },
  worldState: { weather: "klar", timeOfDay: "morgen" }
};

/* ============================================================
   √úBERGABE DER CHARAKTERDATEN AUS SEITE 1 & 2
   ============================================================ */
function UNDRA_applyCharacter() {
  const data = window.UNDRA_CHARACTER;
  if (!data) return;

  const p = UNDRA.player;

  p.name = data.name;
  p.title = data.title;
  p.race = data.race;
  p.subrace = data.subrace;

  // Attribute-Mapping (optional erweiterbar)
  // Beispiel:
  // p.attributes.strength = data.attrs.strength;
  // p.attributes.agility  = data.attrs.agility;

  p.flavour = {
    advantages: data.advantages,
    disadvantages: data.disadvantages,
    backstory: data.backstory,
    profession: data.profession,
    special: data.special,
    traits: data.traits,
    appearance: data.appearance,
    portraitName: data.portraitName
  };

  gameLog("Charakterdaten in Engine √ºbernommen.");
}
</script>
<!-- BLOCK 2 END -->
<!-- BLOCK 3 START -->
<script>
/* ============================================================
   HP / GS / STAMINA / FATIGUE
   ============================================================ */
function applyDamage(target, amount, type = "physisch", reason = "") {
  target.hp.current = clamp(target.hp.current - amount, 0, target.hp.max);
  const label = target === UNDRA.player ? "Du erh√§ltst" : `${target.name} erh√§lt`;
  gameLog(`${label} ${amount} Schaden (${reason || type}).`);

  if (target.hp.current <= 0) {
    onCharacterDefeated(target);
  }

  renderPlayer();
  renderEnemy();
}

function healHP(target, amount, reason = "") {
  target.hp.current = clamp(target.hp.current + amount, 0, target.hp.max);
  gameLog(`${target === UNDRA.player ? "Du" : target.name} heilst ${amount} HP (${reason}).`);
  renderPlayer();
  renderEnemy();
}

function applyGSDamage(target, amount, reason = "") {
  target.gs.current = clamp(target.gs.current - amount, 0, target.gs.max);
  gameLog(`GS -${amount} (${reason}).`);
  renderPlayer();
}

function spendStamina(amount, reason = "") {
  const p = UNDRA.player;
  p.stamina.current = clamp(p.stamina.current - amount, 0, p.stamina.max);
  gameLog(`Ausdauer -${amount} (${reason}).`);

  if (p.stamina.current <= 0) {
    increaseFatigue(1, "Ersch√∂pft");
  }

  renderPlayer();
}

function restoreStamina(amount, reason = "") {
  const p = UNDRA.player;
  p.stamina.current = clamp(p.stamina.current + amount, 0, p.stamina.max);
  gameLog(`Ausdauer +${amount} (${reason}).`);
  renderPlayer();
}

function increaseFatigue(amount = 1, reason = "") {
  const p = UNDRA.player;
  const old = p.fatigue;
  p.fatigue = clamp(p.fatigue + amount, 0, 10);
  gameLog(`Ersch√∂pfung: ${old} ‚Üí ${p.fatigue} (${reason}).`);
}

function reduceFatigue(amount = 1, reason = "") {
  const p = UNDRA.player;
  const old = p.fatigue;
  p.fatigue = clamp(p.fatigue - amount, 0, 10);
  gameLog(`Ersch√∂pfung: ${old} ‚Üí ${p.fatigue} (${reason}).`);
}

function onCharacterDefeated(target) {
  if (target === UNDRA.player) {
    gameLog("Du brichst zusammen. Alles wird schwarz‚Ä¶");
  } else {
    gameLog(`${target.name} ist besiegt.`);
  }
}

/* ============================================================
   STATUS EFFECTS ‚Äì ADD / REMOVE / TICK
   ============================================================ */
function addStatusEffect(target, statusId, duration) {
  const def = UNDRA.StatusRegistry[statusId];
  if (!def) return;

  if (!target.statusEffects) target.statusEffects = [];

  const existing = target.statusEffects.find(s => s.id === statusId);
  if (existing) {
    existing.remaining = Math.max(existing.remaining, duration);
  } else {
    target.statusEffects.push({ id: statusId, remaining: duration });
  }

  if (target === UNDRA.player) {
    gameLog(`Status erhalten: ${def.name} (${duration} Runden).`);
  }
}

function removeStatusEffect(target, statusId) {
  if (!target.statusEffects) return;

  const before = target.statusEffects.length;
  target.statusEffects = target.statusEffects.filter(s => s.id !== statusId);

  if (before !== target.statusEffects.length && target === UNDRA.player) {
    const def = UNDRA.StatusRegistry[statusId];
    gameLog(`Status entfernt: ${def ? def.name : statusId}`);
  }
}

function tickStatusEffects(target) {
  if (!target.statusEffects || !target.statusEffects.length) return;

  target.statusEffects.forEach(se => {
    const def = UNDRA.StatusRegistry[se.id];
    if (def && def.tick) def.tick(target);
    se.remaining--;
  });

  target.statusEffects = target.statusEffects.filter(se => se.remaining > 0);
}

/* ============================================================
   MONEY SYSTEM
   ============================================================ */
function normalizeMoney(m) {
  let total = (m.copper || 0) + (m.silver || 0) * 100 + (m.gold || 0) * 10000;

  const gold = Math.floor(total / 10000);
  total -= gold * 10000;

  const silver = Math.floor(total / 100);
  total -= silver * 100;

  const copper = total;

  return { gold, silver, copper };
}

function addMoney(g = 0, s = 0, c = 0, reason = "") {
  const p = UNDRA.player;

  p.money.gold += g;
  p.money.silver += s;
  p.money.copper += c;

  p.money = normalizeMoney(p.money);

  gameLog(`Geld erhalten: ${g}G ${s}S ${c}K ${reason ? `(${reason})` : ""}`);
  renderPlayer();
}

function subtractMoney(g = 0, s = 0, c = 0, reason = "") {
  const p = UNDRA.player;

  const newMoney = normalizeMoney({
    gold: p.money.gold - g,
    silver: p.money.silver - s,
    copper: p.money.copper - c
  });

  if (newMoney.gold < 0 || newMoney.silver < 0 || newMoney.copper < 0) {
    gameLog("Nicht genug Geld.");
    return false;
  }

  p.money = newMoney;
  gameLog(`Geld ausgegeben: ${g}G ${s}S ${c}K ${reason ? `(${reason})` : ""}`);
  renderPlayer();
  return true;
}

/* ============================================================
   INVENTAR SYSTEM
   ============================================================ */
function findInventoryEntry(id) {
  return UNDRA.player.inventory.find(e => e.id === id) || null;
}

function addItem(id, qty = 1) {
  const def = UNDRA.ItemRegistry[id];
  if (!def) {
    gameLog(`Unbekanntes Item: ${id}`);
    return;
  }

  if (def.stackable) {
    let entry = findInventoryEntry(id);
    if (!entry) {
      entry = { id, quantity: 0 };
      UNDRA.player.inventory.push(entry);
    }
    entry.quantity += qty;

    if (def.maxStack && entry.quantity > def.maxStack) {
      entry.quantity = def.maxStack;
    }
  } else {
    for (let i = 0; i < qty; i++) {
      UNDRA.player.inventory.push({ id, quantity: 1 });
    }
  }

  gameLog(`Item erhalten: ${qty}x ${def.name}`);
  renderInventory();
}

function removeItem(id, qty = 1) {
  const def = UNDRA.ItemRegistry[id];
  if (!def) return false;

  if (def.stackable) {
    const entry = findInventoryEntry(id);
    if (!entry || entry.quantity < qty) {
      gameLog(`Nicht genug ${def.name}`);
      return false;
    }

    entry.quantity -= qty;
    if (entry.quantity <= 0) {
      UNDRA.player.inventory = UNDRA.player.inventory.filter(e => e !== entry);
    }
  } else {
    let remaining = qty;

    UNDRA.player.inventory = UNDRA.player.inventory.filter(e => {
      if (e.id === id && remaining > 0) {
        remaining--;
        return false;
      }
      return true;
    });

    if (remaining > 0) {
      gameLog(`Nicht genug ${def.name}`);
      return false;
    }
  }

  gameLog(`Item entfernt: ${qty}x ${def.name}`);
  renderInventory();
  return true;
}

/* ============================================================
   EQUIPMENT SYSTEM
   ============================================================ */
function equipItem(id) {
  const def = UNDRA.ItemRegistry[id];
  if (!def) return;

  if (def.type === "weapon") {
    UNDRA.player.equipment.weapon = id;
    gameLog(`Waffe ausger√ºstet: ${def.name}`);
  }

  if (def.type === "armor") {
    UNDRA.player.equipment.armor = id;
    gameLog(`R√ºstung ausger√ºstet: ${def.name}`);
  }

  renderEquipment();
  renderPlayer();
}

function unequipItem(type) {
  if (type === "weapon") {
    UNDRA.player.equipment.weapon = null;
    gameLog("Waffe abgelegt.");
  }

  if (type === "armor") {
    UNDRA.player.equipment.armor = null;
    gameLog("R√ºstung abgelegt.");
  }

  renderEquipment();
  renderPlayer();
}

/* ============================================================
   RENDERER ‚Äì PLAYER / INVENTORY / EQUIPMENT
   ============================================================ */
function renderPlayer() {
  const box = document.getElementById("player-display");
  if (!box) return;

  const p = UNDRA.player;

  const hpPct = (p.hp.current / p.hp.max) * 100;
  const gsPct = (p.gs.current / p.gs.max) * 100;
  const staPct = (p.stamina.current / p.stamina.max) * 100;

  let html = `<div><strong>${p.name}</strong> ${p.title ? `<span class="pill">${p.title}</span>` : ""}</div>`;
  html += `<div class="small">Rasse: ${p.race}</div>`;
  html += `<div class="small">Geld: ${p.money.gold}G ${p.money.silver}S ${p.money.copper}K</div>`;

  html += `
    <div class="stat-hp">
      <div class="stat-bar-label"><span>HP</span><span>${p.hp.current}/${p.hp.max}</span></div>
      <div class="stat-bar"><div class="stat-bar-fill" style="width:${hpPct}%;"></div></div>
    </div>

    <div class="stat-gs">
      <div class="stat-bar-label"><span>GS</span><span>${p.gs.current}/${p.gs.max}</span></div>
      <div class="stat-bar"><div class="stat-bar-fill" style="width:${gsPct}%;"></div></div>
    </div>

    <div class="stat-sta">
      <div class="stat-bar-label"><span>STA</span><span>${p.stamina.current}/${p.stamina.max}</span></div>
      <div class="stat-bar"><div class="stat-bar-fill" style="width:${staPct}%;"></div></div>
    </div>

    <div class="small">Ersch√∂pfung: ${p.fatigue}</div>
    <hr>
  `;

  html += `<div class="attr-grid">`;
  Object.keys(p.attributes).forEach(a => {
    html += `<div>${a}</div><div>${p.attributes[a]}</div>`;
  });
  html += `</div>`;

  if (p.statusEffects.length) {
    html += `<hr><div class="small">Status:</div>`;
    p.statusEffects.forEach(s => {
      const def = UNDRA.StatusRegistry[s.id];
      html += `<div class="small">- ${def ? def.name : s.id} (${s.remaining})</div>`;
    });
  }

  box.innerHTML = html;
}

function renderInventory() {
  const box = document.getElementById("inventory-display");
  if (!box) return;

  const inv = UNDRA.player.inventory;

  if (!inv.length) {
    box.innerHTML = "<div class='small'>Inventar leer.</div>";
    return;
  }

  let html = "";
  inv.forEach(e => {
    const it = UNDRA.ItemRegistry[e.id];
    html += `<div class="list-line">${e.quantity}x ${it.name}</div>`;
  });

  box.innerHTML = html;
}

function renderEquipment() {
  const box = document.getElementById("equipment-display");
  if (!box) return;

  const p = UNDRA.player;

  const w = p.equipment.weapon ? UNDRA.ItemRegistry[p.equipment.weapon].name : "keine";
  const a = p.equipment.armor ? UNDRA.ItemRegistry[p.equipment.armor].name : "keine";

  box.innerHTML = `
    <div>Waffe: ${w}</div>
    <div>R√ºstung: ${a}</div>
  `;
}
</script>
<!-- BLOCK 3 END -->
<!-- BLOCK 4 START -->
<script>
/* ============================================================
   KAMPF-SYSTEM
   ============================================================ */

let currentEnemy = null;
let combatRound = 0;
let playerDefending = false;

/* ------------------------------------------------------------
   Gegner erzeugen
------------------------------------------------------------ */
function createEnemy(template) {
  const base = {
    name: "Unbekannter Gegner",
    attributes: {
      strength: 10,
      toughness: 10,
      agility: 10,
      intellect: 10,
      perception: 10,
      willpower: 10,
      charisma: 10,
      empathy: 10,
      presence: 10
    },
    hp: { max: 30, current: 30 },
    gs: { max: 20, current: 20 },
    stamina: { max: 20, current: 20 },
    equipment: { weapon: null, armor: null },
    statusEffects: []
  };

  return Object.assign(base, deepClone(template));
}

/* ------------------------------------------------------------
   Kampf starten / beenden
------------------------------------------------------------ */
function startCombat(template) {
  currentEnemy = createEnemy(template);
  combatRound = 1;
  playerDefending = false;

  gameLog(`‚öîÔ∏è Kampf beginnt gegen ${currentEnemy.name}`);
  renderEnemy();
  renderCombatControls();
}

function endCombat(victory) {
  if (victory) {
    gameLog(`üèÜ Du hast ${currentEnemy.name} besiegt!`);
  } else {
    gameLog("‚ö†Ô∏è Der Kampf endet.");
  }

  currentEnemy = null;
  combatRound = 0;
  playerDefending = false;

  renderEnemy();
  renderCombatControls();
}

/* ------------------------------------------------------------
   Angriffswert / Verteidigungswert
------------------------------------------------------------ */
function getAttackBonus(character) {
  const str = character.attributes.strength || 10;
  const agi = character.attributes.agility || 10;

  return Math.floor((str - 10) / 2) + Math.floor((agi - 10) / 2);
}

function getDefenseValue(character) {
  const agi = character.attributes.agility || 10;
  const per = character.attributes.perception || 10;

  const armorId = character.equipment?.armor;
  const armorVal = armorId ? (UNDRA.ItemRegistry[armorId]?.armorValue || 0) : 0;

  let def = 10
    + Math.floor((agi - 10) / 2)
    + Math.floor((per - 10) / 2)
    + armorVal;

  if (character === UNDRA.player) {
    def -= Math.floor(UNDRA.player.fatigue / 2);
  }

  return def;
}

/* ------------------------------------------------------------
   Angriffswurf
------------------------------------------------------------ */
function rollAttack(attacker, defender) {
  const roll = rollD20();
  const total = roll + getAttackBonus(attacker);
  const defense = getDefenseValue(defender);

  const hit = total >= defense;

  gameLog(`[Angriff] ${attacker.name} w√ºrfelt ${total} gegen ${defense} ‚Üí ${hit ? "Treffer" : "Verfehlt"}`);

  return { hit, roll, total, defense };
}

/* ------------------------------------------------------------
   Schaden
------------------------------------------------------------ */
function rollDamage(attacker) {
  const weaponId = attacker.equipment?.weapon;
  const w = weaponId ? UNDRA.ItemRegistry[weaponId] : null;

  const min = w?.damage?.min ?? 1;
  const max = w?.damage?.max ?? 4;

  const base = rollDN(max - min + 1) + (min - 1);
  const strBonus = Math.floor((attacker.attributes.strength - 10) / 2);

  return Math.max(1, base + strBonus);
}

/* ============================================================
   SPIELER-AKTIONEN
   ============================================================ */
function playerAttack() {
  if (!currentEnemy) return;

  spendStamina(2, "Angriff");

  const result = rollAttack(UNDRA.player, currentEnemy);
  if (!result.hit) {
    enemyTurn();
    return;
  }

  const dmg = rollDamage(UNDRA.player);
  applyDamage(currentEnemy, dmg, "physisch", "Angriff");

  if (currentEnemy.hp.current <= 0) {
    endCombat(true);
    return;
  }

  enemyTurn();
}

function playerDefend() {
  if (!currentEnemy) return;

  playerDefending = true;
  spendStamina(1, "Verteidigen");

  gameLog("üõ°Ô∏è Du gehst in Verteidigungshaltung.");

  enemyTurn();
  playerDefending = false;
}

function playerSpecialMove() {
  if (!currentEnemy) return;

  spendStamina(4, "Spezialangriff");

  const result = rollAttack(UNDRA.player, currentEnemy);
  if (!result.hit) {
    gameLog("‚ùå Spezialangriff verfehlt.");
    enemyTurn();
    return;
  }

  let dmg = Math.floor(rollDamage(UNDRA.player) * 1.5);
  applyDamage(currentEnemy, dmg, "physisch", "Spezialangriff");

  if (rollD20() >= 18) {
    addStatusEffect(currentEnemy, "stunned", 1);
    gameLog(`üí´ ${currentEnemy.name} ist benommen!`);
  }

  if (currentEnemy.hp.current <= 0) {
    endCombat(true);
    return;
  }

  enemyTurn();
}

/* ============================================================
   GEGNER-KI
   ============================================================ */
function enemyTurn() {
  if (!currentEnemy) return;

  const stunned = currentEnemy.statusEffects?.some(s => s.id === "stunned");
  if (stunned) {
    gameLog(`üí´ ${currentEnemy.name} ist benommen und handelt nicht.`);
    nextCombatRound();
    return;
  }

  const result = rollAttack(currentEnemy, UNDRA.player);
  if (!result.hit) {
    nextCombatRound();
    return;
  }

  let dmg = rollDamage(currentEnemy);

  if (playerDefending) {
    dmg = Math.max(0, dmg - 2);
    gameLog("üõ°Ô∏è Deine Verteidigung reduziert den Schaden.");
  }

  applyDamage(UNDRA.player, dmg, "physisch", `Angriff von ${currentEnemy.name}`);

  if (UNDRA.player.hp.current <= 0) {
    endCombat(false);
    return;
  }

  nextCombatRound();
}

function nextCombatRound() {
  combatRound++;
  gameLog(`‚Äî Runde ${combatRound} ‚Äî`);

  tickStatusEffects(UNDRA.player);
  if (currentEnemy) tickStatusEffects(currentEnemy);

  renderPlayer();
  renderEnemy();
}

/* ============================================================
   KAMPF-UI
   ============================================================ */
function renderCombatControls() {
  const box = document.getElementById("combat-controls");
  if (!box) return;

  if (!currentEnemy) {
    box.innerHTML = "<div class='small'>Kein Kampf aktiv.</div>";
    return;
  }

  box.innerHTML = `
    <button onclick="playerAttack()">Angreifen</button>
    <button onclick="playerDefend()">Verteidigen</button>
    <button onclick="playerSpecialMove()">Spezial</button>
  `;
}

/* ============================================================
   GEGNER-RENDERER
   ============================================================ */
function renderEnemy() {
  const box = document.getElementById("enemy-display");
  if (!box) return;

  if (!currentEnemy) {
    box.innerHTML = "<div class='small'>Kein Gegner aktiv.</div>";
    return;
  }

  let html = `<div><strong>${currentEnemy.name}</strong></div>`;
  html += `<div>HP: ${currentEnemy.hp.current}/${currentEnemy.hp.max}</div>`;
  html += `<div>STA: ${currentEnemy.stamina.current}/${currentEnemy.stamina.max}</div>`;

  if (currentEnemy.statusEffects.length) {
    html += `<div class="small">Status:</div>`;
    currentEnemy.statusEffects.forEach(s => {
      const def = UNDRA.StatusRegistry[s.id];
      html += `<div class="small">- ${def ? def.name : s.id} (${s.remaining})</div>`;
    });
  }

  box.innerHTML = html;
}

/* ============================================================
   TESTKAMPF
   ============================================================ */
function testCombat() {
  const enemyTemplate = {
    name: "Goblin-Pl√ºnderer",
    hp: { max: 20, current: 20 },
    gs: { max: 10, current: 10 },
    stamina: { max: 20, current: 20 },
    attributes: {
      strength: 9,
      toughness: 8,
      agility: 12,
      intellect: 8,
      perception: 10,
      willpower: 8,
      charisma: 6,
      empathy: 5,
      presence: 7
    },
    equipment: { weapon: "dagger", armor: null },
    statusEffects: []
  };

  startCombat(enemyTemplate);
}
</script>
<!-- BLOCK 4 END -->
<!-- BLOCK 5 START -->
<script>
/* ============================================================
   NPC & DIALOG-SYSTEM
   ============================================================ */

let currentNPC = null;
let currentDialogNode = null;

/* NPC erzeugen */
function createNPC(template) {
  return deepClone(template);
}

/* Dialog starten */
function startDialog(npc) {
  currentNPC = npc;
  currentDialogNode = npc.dialogTree.nodes[npc.dialogTree.start];

  gameLog(`üí¨ Du sprichst mit ${npc.name}.`);
  renderDialog();
}

/* Dialogoption w√§hlen */
function chooseDialogOption(i) {
  if (!currentDialogNode) return;

  const opt = currentDialogNode.options[i];
  if (!opt) return;

  /* Skill-Check */
  if (opt.skill) {
    const result = performSkillCheck
      ? performSkillCheck(opt.skill, opt.difficulty || "normal", {
          consumeStamina: true,
          staminaCost: 1,
          label: "Dialogprobe"
        })
      : { success: true }; // Fallback

    currentDialogNode = currentNPC.dialogTree.nodes[
      result.success ? opt.success : opt.fail
    ];

    renderDialog();
    return;
  }

  /* Normale Weiterleitung */
  if (opt.next) {
    currentDialogNode = currentNPC.dialogTree.nodes[opt.next];
    renderDialog();
    return;
  }

  /* Dialog beenden */
  if (opt.end) {
    gameLog(`üí¨ Gespr√§ch mit ${currentNPC.name} beendet.`);
    currentNPC = null;
    currentDialogNode = null;
    renderDialog();
  }
}

/* Dialog anzeigen */
function renderDialog() {
  const box = document.getElementById("dialog-display");
  if (!box) return;

  if (!currentNPC || !currentDialogNode) {
    box.innerHTML = "<div class='small'>Kein aktiver Dialog.</div>";
    return;
  }

  let html = `<div><strong>${currentNPC.name}</strong></div>`;
  html += `<div>${currentDialogNode.text}</div><hr>`;

  currentDialogNode.options.forEach((opt, i) => {
    html += `<button onclick="chooseDialogOption(${i})">${opt.text}</button><br>`;
  });

  box.innerHTML = html;
}

/* TEST-NPC */
function testNPCDialog() {
  const npc = createNPC({
    name: "Dorf√§ltester",
    dialogTree: {
      start: "n1",
      nodes: {
        n1: {
          text: "Willkommen in unserem Dorf, Fremder.",
          options: [
            { text: "Freundlich gr√º√üen", next: "n2" },
            { text: "Einsch√ºchtern", skill: "intimidation", difficulty: "normal", success: "n3", fail: "n4" },
            { text: "Auf Wiedersehen", end: true }
          ]
        },
        n2: {
          text: "Es tut gut, freundliche Gesichter zu sehen.",
          options: [{ text: "Danke", end: true }]
        },
        n3: {
          text: "Bitte! Tu mir nichts! Ich sage dir alles...",
          options: [{ text: "Beruhigen", next: "n2" }]
        },
        n4: {
          text: "Du wirkst nicht besonders bedrohlich...",
          options: [{ text: "Nochmal versuchen", next: "n1" }]
        }
      }
    }
  });

  startDialog(npc);
}

/* ============================================================
   H√ÑNDLER-SYSTEM
   ============================================================ */

let currentMerchant = null;

/* H√§ndler erzeugen */
function createMerchant(template) {
  return deepClone(template);
}

/* H√§ndler √∂ffnen */
function startMerchant(template) {
  currentMerchant = createMerchant(template);

  gameLog(`üõí Du betrittst den Laden von ${currentMerchant.name}.`);
  renderMerchant();
}

/* H√§ndler anzeigen */
function renderMerchant() {
  const box = document.getElementById("merchant-display");
  if (!box) return;

  if (!currentMerchant) {
    box.innerHTML = "<div class='small'>Kein H√§ndler aktiv.</div>";
    return;
  }

  let html = `<div><strong>${currentMerchant.name}</strong></div>`;
  html += `<div class="small">Preise: Kaufen x${currentMerchant.priceBuy}, Verkaufen x${currentMerchant.priceSell}</div><hr>`;

  /* Angebot */
  html += `<div><strong>Angebot:</strong></div>`;
  if (!currentMerchant.inventory.length) {
    html += `<div class="small">Keine Waren.</div>`;
  }

  currentMerchant.inventory.forEach((entry, i) => {
    const it = UNDRA.ItemRegistry[entry.id];
    if (!it) return;

    const price = Math.floor((it.value || 1) * currentMerchant.priceBuy);

    html += `
      <div class="list-line">
        ${entry.quantity}x ${it.name} ‚Äì ${price}K
        <button onclick="buyItem(${i})">Kaufen</button>
      </div>
    `;
  });

  /* Verkauf */
  html += `<hr><div><strong>Verkaufen:</strong></div>`;

  if (!UNDRA.player.inventory.length) {
    html += `<div class="small">Du hast nichts zu verkaufen.</div>`;
  }

  UNDRA.player.inventory.forEach((entry, i) => {
    const it = UNDRA.ItemRegistry[entry.id];
    if (!it) return;

    const price = Math.floor((it.value || 1) * currentMerchant.priceSell);

    html += `
      <div class="list-line">
        ${entry.quantity}x ${it.name} ‚Äì ${price}K
        <button onclick="sellItem(${i})">Verkaufen</button>
      </div>
    `;
  });

  box.innerHTML = html;
}

/* Kaufen */
function buyItem(i) {
  if (!currentMerchant) return;

  const entry = currentMerchant.inventory[i];
  if (!entry) return;

  const it = UNDRA.ItemRegistry[entry.id];
  const price = Math.floor((it.value || 1) * currentMerchant.priceBuy);

  if (!subtractMoney(0, 0, price, `Kauf: ${it.name}`)) return;

  addItem(entry.id, 1);

  entry.quantity--;
  if (entry.quantity <= 0) currentMerchant.inventory.splice(i, 1);

  renderMerchant();
}

/* Verkaufen */
function sellItem(i) {
  if (!currentMerchant) return;

  const entry = UNDRA.player.inventory[i];
  if (!entry) return;

  const it = UNDRA.ItemRegistry[entry.id];
  const price = Math.floor((it.value || 1) * currentMerchant.priceSell);

  if (!removeItem(entry.id, 1)) return;

  addMoney(0, 0, price, `Verkauf: ${it.name}`);

  let mEntry = currentMerchant.inventory.find(e => e.id === entry.id);
  if (!mEntry) {
    mEntry = { id: entry.id, quantity: 0 };
    currentMerchant.inventory.push(mEntry);
  }

  mEntry.quantity++;

  renderMerchant();
}

/* TEST-H√ÑNDLER */
function testMerchant() {
  startMerchant({
    name: "H√§ndler Torvan",
    priceBuy: 1.0,
    priceSell: 0.5,
    inventory: [
      { id: "sword", quantity: 2 },
      { id: "healthPotion", quantity: 5 },
      { id: "ironOre", quantity: 10 }
    ]
  });
}

/* ============================================================
   CRAFTING-SYSTEM
   ============================================================ */

const CraftingRegistry = {
  healthPotion: {
    id: "healthPotion",
    name: "Heiltrank",
    skill: "alchemy",
    difficulty: "normal",
    workstation: "alchemyTable",
    ingredients: [
      { id: "herb", quantity: 2 },
      { id: "water", quantity: 1 }
    ],
    result: { id: "healthPotion", quantity: 1 }
  },

  ironSword: {
    id: "ironSword",
    name: "Eisenschwert",
    skill: "crafting",
    difficulty: "hard",
    workstation: "forge",
    ingredients: [
      { id: "ironOre", quantity: 5 },
      { id: "wood", quantity: 1 }
    ],
    result: { id: "sword", quantity: 1 }
  }
};

const Workstations = {
  forge: "Schmiede",
  alchemyTable: "Alchemietisch"
};

let currentWorkstation = null;

/* Werkbank benutzen */
function useWorkstation(type) {
  if (!Workstations[type]) {
    gameLog("Unbekannte Werkbank.");
    return;
  }

  currentWorkstation = type;
  gameLog(`üîß Du benutzt: ${Workstations[type]}`);

  renderCrafting();
}

/* Zutaten pr√ºfen */
function hasIngredients(recipe) {
  return recipe.ingredients.every(ing => {
    const entry = findInventoryEntry(ing.id);
    return entry && entry.quantity >= ing.quantity;
  });
}

/* Zutaten verbrauchen */
function consumeIngredients(recipe) {
  recipe.ingredients.forEach(ing => removeItem(ing.id, ing.quantity));
}

/* Crafting durchf√ºhren */
function craftItem(recipeId) {
  if (!currentWorkstation) {
    gameLog("Keine Werkbank aktiv.");
    return;
  }

  const recipe = CraftingRegistry[recipeId];
  if (!recipe) {
    gameLog("Unbekanntes Rezept.");
    return;
  }

  if (recipe.workstation !== currentWorkstation) {
    gameLog(`Dieses Rezept ben√∂tigt: ${Workstations[recipe.workstation]}`);
    return;
  }

  if (!hasIngredients(recipe)) {
    gameLog("Dir fehlen Materialien.");
    return;
  }

  const result = performSkillCheck
    ? performSkillCheck(recipe.skill, recipe.difficulty, {
        consumeStamina: true,
        staminaCost: 2,
        label: `Herstellung: ${recipe.name}`
      })
    : { success: true };

  consumeIngredients(recipe);

  if (!result.success) {
    gameLog(`‚ùå Die Herstellung von ${recipe.name} misslingt.`);
    return;
  }

  addItem(recipe.result.id, recipe.result.quantity);

  gameLog(`‚úîÔ∏è Herstellung erfolgreich: ${recipe.result.quantity}x ${UNDRA.ItemRegistry[recipe.result.id].name}`);

  renderCrafting();
}

/* Crafting anzeigen */
function renderCrafting() {
  const box = document.getElementById("crafting-display");
  if (!box) return;

  if (!currentWorkstation) {
    box.innerHTML = "<div class='small'>Keine Werkbank aktiv. W√§hle Schmiede oder Alchemietisch.</div>";
    return;
  }

  let html = `<div><strong>Werkbank:</strong> ${Workstations[currentWorkstation]}</div><hr>`;

  const recipes = Object.values(CraftingRegistry).filter(r => r.workstation === currentWorkstation);

  if (!recipes.length) {
    html += "<div class='small'>Keine Rezepte f√ºr diese Werkbank.</div>";
    box.innerHTML = html;
    return;
  }

  recipes.forEach(r => {
    const canCraft = hasIngredients(r);

    html += `
      <div><strong>${r.name}</strong> <span class="small">[Skill: ${r.skill}, Schwierigkeit: ${r.difficulty}]</span></div>
      <div class="small">Ben√∂tigt:</div>
      <ul>
    `;

    r.ingredients.forEach(ing => {
      const it = UNDRA.ItemRegistry[ing.id];
      html += `<li class="small">${ing.quantity}x ${it ? it.name : ing.id}</li>`;
    });

    html += `
      </ul>
      <button onclick="craftItem('${r.id}')" ${canCraft ? "" : "disabled"}>
        ${canCraft ? "Herstellen" : "Fehlende Materialien"}
      </button>
      <hr>
    `;
  });

  box.innerHTML = html;
}

/* TEST-CRAFTING */
function testCrafting() {
  useWorkstation("forge");
}
</script>
<!-- BLOCK 5 END -->
<!-- BLOCK 6 START -->
<script>
/* ============================================================
   WELT-SYSTEM
   ============================================================ */

UNDRA.World = {
  regions: {
    forest: {
      id: "forest",
      name: "Der Immerwald",
      locations: {
        forestEdge: {
          id: "forestEdge",
          name: "Waldrand",
          encounters: ["goblin", "wolf", "nothing"]
        },
        deepForest: {
          id: "deepForest",
          name: "Tiefer Wald",
          encounters: ["wolf", "bandit", "nothing", "nothing"]
        }
      }
    },

    village: {
      id: "village",
      name: "Dorf Eichenruh",
      locations: {
        market: {
          id: "market",
          name: "Marktplatz",
          encounters: ["merchant", "nothing"]
        },
        tavern: {
          id: "tavern",
          name: "Taverne 'Zum Krummen Ast'",
          encounters: ["npc", "nothing"]
        }
      }
    }
  },

  weather: ["klar", "bew√∂lkt", "regen", "sturm"],
  timeOfDay: ["morgen", "mittag", "abend", "nacht"]
};

/* ============================================================
   REISEN
   ============================================================ */

function travelTo(regionId, locationId) {
  const region = UNDRA.World.regions[regionId];
  if (!region) {
    gameLog("Unbekannte Region.");
    return;
  }

  const loc = region.locations[locationId];
  if (!loc) {
    gameLog("Unbekannter Ort.");
    return;
  }

  UNDRA.player.position.region = regionId;
  UNDRA.player.position.location = locationId;

  gameLog(`üåç Du reist nach: ${region.name} ‚Äì ${loc.name}`);

  updateWorldState();
  renderWorld();
  checkEncounter();
}

/* ============================================================
   WETTER & TAGESZEIT
   ============================================================ */

function updateWorldState() {
  const w = UNDRA.World.weather;
  const t = UNDRA.World.timeOfDay;

  UNDRA.player.worldState.weather = w[Math.floor(Math.random() * w.length)];
  UNDRA.player.worldState.timeOfDay = t[Math.floor(Math.random() * t.length)];
}

/* ============================================================
   ZUFALLSBEGEGNUNGEN
   ============================================================ */

function checkEncounter() {
  const pos = UNDRA.player.position;
  const region = UNDRA.World.regions[pos.region];
  const loc = region.locations[pos.location];

  const list = loc.encounters;
  const result = list[Math.floor(Math.random() * list.length)];

  if (result === "nothing") {
    gameLog("Nichts passiert.");
    return;
  }

  if (result === "goblin") {
    gameLog("Ein Goblin taucht auf!");
    startCombat({
      name: "Goblin",
      hp: { max: 18, current: 18 },
      gs: { max: 10, current: 10 },
      stamina: { max: 20, current: 20 },
      attributes: {
        strength: 9,
        toughness: 8,
        agility: 12,
        intellect: 8,
        perception: 10,
        willpower: 8,
        charisma: 6,
        empathy: 5,
        presence: 7
      },
      equipment: { weapon: "dagger", armor: null },
      statusEffects: []
    });
    return;
  }

  if (result === "wolf") {
    gameLog("Ein Wolf knurrt aus dem Geb√ºsch!");
    startCombat({
      name: "Wolf",
      hp: { max: 22, current: 22 },
      gs: { max: 12, current: 12 },
      stamina: { max: 20, current: 20 },
      attributes: {
        strength: 11,
        toughness: 10,
        agility: 13,
        intellect: 6,
        perception: 12,
        willpower: 8,
        charisma: 5,
        empathy: 4,
        presence: 6
      },
      equipment: { weapon: null, armor: null },
      statusEffects: []
    });
    return;
  }

  if (result === "bandit") {
    gameLog("Ein Bandit stellt sich dir in den Weg!");
    startCombat({
      name: "Bandit",
      hp: { max: 25, current: 25 },
      gs: { max: 15, current: 15 },
      stamina: { max: 25, current: 25 },
      attributes: {
        strength: 10,
        toughness: 10,
        agility: 11,
        intellect: 9,
        perception: 10,
        willpower: 9,
        charisma: 7,
        empathy: 6,
        presence: 8
      },
      equipment: { weapon: "sword", armor: "leatherArmor" },
      statusEffects: []
    });
    return;
  }

  if (result === "merchant") {
    gameLog("Ein reisender H√§ndler erscheint.");
    testMerchant();
    return;
  }

  if (result === "npc") {
    gameLog("Eine Person spricht dich an.");
    testNPCDialog();
    return;
  }
}

/* ============================================================
   WELT-RENDERER
   ============================================================ */

function renderWorld() {
  const box = document.getElementById("world-display");
  if (!box) return;

  const p = UNDRA.player;
  const region = UNDRA.World.regions[p.position.region];
  const loc = region.locations[p.position.location];

  box.innerHTML = `
    <div><strong>Region:</strong> ${region.name}</div>
    <div><strong>Ort:</strong> ${loc.name}</div>
    <div><strong>Wetter:</strong> ${p.worldState.weather}</div>
    <div><strong>Tageszeit:</strong> ${p.worldState.timeOfDay}</div>
    <hr>
    <button onclick="travelTo('forest','forestEdge')">Waldrand</button>
    <button onclick="travelTo('forest','deepForest')">Tiefer Wald</button>
    <button onclick="travelTo('village','market')">Marktplatz</button>
    <button onclick="travelTo('village','tavern')">Taverne</button>
  `;
}

/* ============================================================
   DEBUG-TOOLS
   ============================================================ */

function debugGiveItems() {
  addItem("ironOre", 10);
  addItem("herb", 10);
  addItem("water", 5);
  addItem("wood", 5);
  addItem("healthPotion", 3);
  gameLog("Debug: Materialien hinzugef√ºgt.");
}

function debugHeal() {
  UNDRA.player.hp.current = UNDRA.player.hp.max;
  UNDRA.player.stamina.current = UNDRA.player.stamina.max;
  gameLog("Debug: HP & STA voll.");
  renderPlayer();
}

/* ============================================================
   INITIALISIERUNG
   ============================================================ */

function initUNDRA() {
  gameLog("UNDRA ENGINE v1.0 gestartet.");

  renderPlayer();
  renderInventory();
  renderEquipment();
  renderWorld();
  renderCombatControls();
  renderDialog();
  renderMerchant();
  renderCrafting();
}

/* ============================================================
   SEITE 3 ‚Äì ENGINE-UI
   ============================================================ */
</script>

<style>
  .engine-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .engine-box {
    border: 1px solid #333;
    padding: 10px;
    background: #1a1a1a;
  }
</style>

<div id="page3" class="panel hidden">
  <h2>UNDRA ENGINE v1.0</h2>

  <button onclick="UNDRA_applyCharacter(); initUNDRA();">Charakter laden & Engine starten</button>
  <hr>

  <div class="engine-grid">
    <div class="engine-box">
      <h3>Spieler</h3>
      <div id="player-display"></div>
    </div>

    <div class="engine-box">
      <h3>Gegner</h3>
      <div id="enemy-display"></div>
      <div id="combat-controls" style="margin-top:6px;"></div>
      <button onclick="testCombat()">Testkampf</button>
    </div>

    <div class="engine-box">
      <h3>Inventar</h3>
      <div id="inventory-display"></div>
    </div>

    <div class="engine-box">
      <h3>Ausr√ºstung</h3>
      <div id="equipment-display"></div>
    </div>

    <div class="engine-box">
      <h3>Dialog</h3>
      <div id="dialog-display"></div>
      <button onclick="testNPCDialog()">Test-NPC</button>
    </div>

    <div class="engine-box">
      <h3>H√§ndler</h3>
      <div id="merchant-display"></div>
      <button onclick="testMerchant()">Test-H√§ndler</button>
    </div>

    <div class="engine-box">
      <h3>Crafting</h3>
      <div id="crafting-display"></div>
      <button onclick="useWorkstation('forge')">Schmiede</button>
      <button onclick="useWorkstation('alchemyTable')">Alchemietisch</button>
      <button onclick="testCrafting()">Test-Crafting</button>
    </div>

    <div class="engine-box">
      <h3>Welt</h3>
      <div id="world-display"></div>
    </div>

    <div class="engine-box" style="grid-column: span 2;">
      <h3>Log</h3>
      <div id="game-log" style="height:200px; overflow-y:auto; background:#111; padding:6px;"></div>
    </div>
  </div>
</div>

<!-- BLOCK 6 END -->
